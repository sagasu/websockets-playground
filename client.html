<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Client</title>
</head>
<body>
    <h1>Cliet</h1>
    <p id="stateLabel">Ready to connect</p>
    <p id="connectionId">ConnectionID: </p>
    <div>
        <label for="connectionUrl">Server URL</label>
        <input id="connectionUrl"/>
        <button id="connectButton" type="submit">Connect</button>
        <button id="closeButton" disabled>Close Socket</button>
    </div>
    <div>
        <label for="message">Message</label>
        <input id="message"/>
        <button id="sendButton" type="submit" disabled>Send</button>
    </div>        
    <div>
        <label for="recipients">Recipients</label>
        <input id="recipients" disabled/>
    </div>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Message</th>
                <th>Recipients</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody id="log">
        </tbody>
    </table>
</body>
<script>
    let connectionUrl = document.getElementById('connectionUrl');
    let connectionButton = document.getElementById('connectButton');
    let stateLabel = document.getElementById('stateLabel');
    let sendMessage = document.getElementById('message');
    let sendButton = document.getElementById('sendButton');
    let log = document.getElementById('log');
    let closeButton = document.getElementById('closeButton');
    let recipient = document.getElementById('recipients');
    let connectionId = document.getElementById('connectionId');

    connectionUrl.value = "ws://localhost:5000";
    connectionButton.onclick = function(){
        stateLabel.innerHTML = "Connecting...";
        let socket = new WebSocket(connectionUrl.value);
        socket.onopen = function(event) {
            updateState();
            log.innerHTML += "<tr><td>Connection opened</td></tr>";

        };

        socket.onclose = function(event) {
            updateState();
            log.innerHTML += `<tr><td>Connection closed ${htmlEscape(event.code)} reason: ${htmlEscape(event.reason)}</td></tr>`;
        };

        socket.onerror = updateState();
        socket.onmessage = function(event) {
            let data = JSON.parse(event.data);
            let message = data.message;
            log.innerHTML += `<tr><td>${htmlEscape(message.id)}</td><td>${htmlEscape(message.message)}</td><td>${htmlEscape(message.recipients)}</td><td>${htmlEscape(message.date)}</td></tr>`;
        };
    };

    const htmlEscape = function(str) {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    };
    const updateState = function(){
        if(socket.readyState === WebSocket.OPEN){
            stateLabel.innerHTML = "Connected";
        }};

</script>
</html>